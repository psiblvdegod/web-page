{% extends "base.html" %}

{% block title %}comments{% endblock %}

{% block styles %}
<style>
    /* Убираем фиксированную высоту для возможности скролла всей страницы */
    body.comments-page {
        overflow-y: auto;
        /* Разрешаем вертикальную прокрутку */
        min-height: 100vh;
        /* Минимальная высота на весь экран */
        /* Убираем виньетку */
        box-shadow: none !important;
    }

    .gif-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        object-fit: cover;
        opacity: 0.7;
        pointer-events: none;
        /* Чтобы не мешал скроллу */
    }

    .cover-container {
        position: relative;
        z-index: 1;
        color: white;
        min-height: 100vh;
        /* Минимум на весь экран */
        display: flex;
        flex-direction: column;
        max-width: 42em;
        /* Берем значение из cover.css */
        margin: 0 auto;
        padding: 0 15px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7);
    }

    .comment {
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-bottom: .75rem;
        text-align: left;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .comment .author {
        font-weight: 600;
        color: #fff;
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }

    .comment .time {
        font-size: .85rem;
        color: rgba(255, 255, 255, 0.6);
        margin-left: 0.5rem;
    }

    .comment .body {
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.5;
        word-wrap: break-word;
        margin-top: 0.5rem;
    }

    .login-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 1rem;
        flex-wrap: wrap;
    }

    .login-button {
        flex: 1;
        min-width: 180px;
        max-width: 250px;
    }

    .auth-status {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 15px;
        padding: 1rem 0;
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        margin-top: 2rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        padding: 1rem;
    }

    .auth-info {
        flex-grow: 1;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.95rem;
    }

    .auth-buttons {
        display: flex;
        gap: 10px;
    }

    .auth-buttons .btn {
        flex: 1;
        min-width: 100px;
        white-space: nowrap;
    }

    /* Основной контейнер с гибкой высотой */
    .comments-page .cover-container {
        min-height: 100vh;
        padding: 1rem 0;
    }

    .comments-page main {
        flex: 1;
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    .comments-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
        width: 100%;
    }

    /* Контейнер для списка комментариев с адаптивной высотой */
    .comments-scrollable {
        flex: 1;
        overflow-y: auto;
        max-height: 60vh;
        /* Максимальная высота, но может увеличиваться */
        min-height: 200px;
        /* Минимальная высота */
        padding-right: 5px;
        margin-bottom: 1.5rem;
        border-radius: 6px;
        background: rgba(0, 0, 0, 0.15);
        padding: 1rem;
    }

    /* Стили для скроллбара */
    .comments-scrollable::-webkit-scrollbar {
        width: 6px;
    }

    .comments-scrollable::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
    }

    .comments-scrollable::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
    }

    .comments-scrollable::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Форма и кнопки */
    .comment-form-container {
        background: rgba(0, 0, 0, 0.15);
        padding: 1.25rem;
        border-radius: 6px;
        margin-top: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .login-buttons-container {
        background: rgba(0, 0, 0, 0.15);
        padding: 1.25rem;
        border-radius: 6px;
        margin-top: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Заголовок страницы */
    .page-title {
        text-align: center;
        margin-bottom: 1.5rem;
        color: #fff;
    }

    .page-title h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
        margin-bottom: 2rem;
    }

    /* Стиль для auth-badge (одинаковый для Яндекс и Google) */
    .auth-badge {
        background: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.2);
        font-weight: normal;
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
        margin-left: 0.5rem;
    }

    /* Убираем стандартные цвета Bootstrap для badge */
    .auth-badge.bg-info,
    .auth-badge.bg-danger {
        background: rgba(255, 255, 255, 0.15) !important;
        color: rgba(255, 255, 255, 0.9) !important;
    }

    /* Стиль для иконок в badge */
    .auth-badge i {
        color: rgba(255, 255, 255, 0.9);
        margin-right: 0.25rem;
    }

    /* Стили для текстового поля без label */
    .comment-form-container .mb-3 {
        margin-bottom: 1rem !important;
    }

    /* Убираем label у textarea */
    .comment-form-container label {
        display: none;
    }

    /* Стиль для textarea */
    .comment-form-container textarea {
        width: 100%;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
        border-radius: 4px;
        padding: 0.75rem;
        font-size: 1rem;
        resize: vertical;
        min-height: 100px;
    }

    .comment-form-container textarea:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.4);
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
    }

    .comment-form-container textarea::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    /* Кнопки в форме */
    .form-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 1rem;
    }

    /* Адаптивность для мобильных устройств */
    @media (max-width: 768px) {
        .comments-scrollable {
            max-height: 50vh;
            padding: 0.75rem;
        }

        .login-buttons {
            flex-direction: column;
        }

        .login-button {
            min-width: 100%;
        }

        .auth-status {
            flex-direction: column;
            text-align: center;
            gap: 10px;
        }

        .auth-buttons {
            width: 100%;
            justify-content: center;
        }

        .page-title h1 {
            font-size: 2rem;
        }

        .cover-container {
            padding: 0 10px;
        }
    }

    /* Для очень маленьких экранов */
    @media (max-height: 600px) {
        .comments-scrollable {
            max-height: 40vh;
        }
    }

    /* Для больших экранов */
    @media (min-height: 900px) {
        .comments-scrollable {
            max-height: 70vh;
        }
    }

    /* Эффекты при наведении */
    .comment:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
    }

    /* Кнопка удаления комментария */
    .comment form button {
        opacity: 0.7;
        transition: opacity 0.2s ease;
        background: rgba(220, 53, 69, 0.2);
        border-color: rgba(220, 53, 69, 0.5);
        color: rgba(255, 255, 255, 0.9);
    }

    .comment form button:hover {
        opacity: 1;
        background: rgba(220, 53, 69, 0.3);
        border-color: rgba(220, 53, 69, 0.7);
    }

    /* Статус "нет комментариев" */
    .no-comments {
        text-align: center;
        padding: 2rem;
        color: rgba(255, 255, 255, 0.6);
    }

    .no-comments i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Счетчик символов */
    .char-counter {
        display: flex;
        justify-content: space-between;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
    }

    .char-counter .count {
        font-weight: bold;
    }

    .char-counter .warning {
        color: #ff6b6b;
    }

    .char-counter .normal {
        color: rgba(255, 255, 255, 0.9);
    }
</style>
{% endblock %}

{% block background %}
<img src="{{ url_for('static', filename='images/comments-back.gif') }}" class="gif-background"
    alt="Comments background">
{% endblock %}

{% block content %}
<div class="comments-section">
    <div class="page-title">
        <h1>Комментарии</h1>
        <p class="lead text-white-50 mb-3">Здесь показаны комментарии пользователей</p>
    </div>

    <div class="comments-content">
        <!-- Контейнер для прокрутки комментариев -->
        <div class="comments-scrollable">
            {% if comments %}
            {% for c in comments %}
            <div class="comment">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="author">{{ c.user.name or c.user.email }}</div>
                    <div class="time">{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                </div>
                <div class="body">{{ c.body }}</div>
                {% if current_user.is_authenticated and c.user_id == current_user.id %}
                <div class="mt-2">
                    <form action="{{ url_for('delete_comment', comment_id=c.id) }}" method="post"
                        onsubmit="return confirm('Удалить этот комментарий?');">
                        <button class="btn btn-sm btn-outline-danger" type="submit">
                            Удалить
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="no-comments">
                <p class="fs-5">Пока нет комментариев. Будьте первым!</p>
            </div>
            {% endif %}
        </div>

        <!-- Форма добавления комментария (только для авторизованных) -->
        {% if current_user.is_authenticated %}
        <div class="comment-form-container authenticated">
            <form method="post" class="mt-3" id="commentForm">
                {{ form.csrf_token }}
                <div class="mb-3">
                    {{ form.body(class="form-control",
                    id="body",
                    rows="4",
                    placeholder="Напишите ваш комментарий здесь...",
                    oninput="updateCharCount()") }}
                    <div class="char-counter">
                        <span>Осталось символов:</span>
                        <span id="charCount" class="count normal">500</span>
                    </div>
                    {% if form.body.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.body.errors %}
                        <span class="text-warning">{{ error }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="form-buttons">
                    {{ form.submit(class_="btn btn-light fw-bold px-4 py-2") }}
                    <button type="button" class="btn btn-outline-light" onclick="clearForm()">
                        Очистить
                    </button>
                </div>
            </form>
        </div>
        {% else %}
        <!-- Кнопки входа (только для неавторизованных) -->
        <div class="login-buttons-container">
            <div class="login-buttons">
                <a href="{{ url_for('login_yandex') }}" class="btn btn-light fw-bold login-button"
                    onclick="trackLoginClick('yandex')">
                    Войти через Яндекс
                </a>
                <a href="{{ url_for('login_google') }}" class="btn btn-light fw-bold login-button"
                    onclick="trackLoginClick('google')">
                    Войти через Google
                </a>
            </div>
            <div class="mt-3 text-center">
                <a href="{{ url_for('index') }}" class="btn btn-outline-light fw-bold">
                    На главную
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if current_user.is_authenticated %}
<div class="auth-status">
    <div class="auth-info">
        Вы вошли как <strong>{{ current_user.name or current_user.email }}</strong>
        {% if current_user.yandex_id %}
        <span class="badge auth-badge">Яндекс</span>
        {% elif current_user.google_id %}
        <span class="badge auth-badge">Google</span>
        {% endif %}
    </div>
    <div class="auth-buttons">
        <a href="{{ url_for('index') }}" class="btn btn-light fw-bold">
            На главную
        </a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light fw-bold" onclick="trackLogoutClick()">
            Выйти
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Функция для автоматической прокрутки к новым комментариям
        const commentsContainer = document.querySelector('.comments-scrollable');
        if (commentsContainer) {
            // Прокручиваем к низу, если есть комментарии
            if (commentsContainer.scrollHeight > commentsContainer.clientHeight) {
                commentsContainer.scrollTop = commentsContainer.scrollHeight;
            }

            // Добавляем обработчик для плавной прокрутки при добавлении новых комментариев
            const observer = new MutationObserver(function () {
                commentsContainer.scrollTo({
                    top: commentsContainer.scrollHeight,
                    behavior: 'smooth'
                });
            });

            observer.observe(commentsContainer, { childList: true, subtree: true });
        }

        // Инициализация счетчика символов
        updateCharCount();

        // Добавляем класс для страницы комментариев
        document.body.classList.add('comments-page');
    });

    // Функция для обновления счетчика символов (обратный отсчет)
    function updateCharCount() {
        const textarea = document.getElementById('body');
        const charCount = document.getElementById('charCount');
        if (textarea && charCount) {
            const length = textarea.value.length;
            const remaining = 500 - length;
            charCount.textContent = remaining;

            // Меняем цвет при приближении к лимиту
            if (remaining < 50) {
                charCount.className = 'count warning';
            } else if (remaining < 100) {
                charCount.className = 'count normal';
            } else {
                charCount.className = 'count normal';
            }

            // Предупреждение при превышении лимита
            if (length > 500) {
                textarea.value = textarea.value.substring(0, 500);
                updateCharCount();
            }
        }
    }

    // Функция для очистки формы
    function clearForm() {
        const textarea = document.getElementById('body');
        if (textarea) {
            textarea.value = '';
            updateCharCount();
            textarea.focus();
        }
    }

    // Функции для отслеживания событий в GTM
    function trackLoginClick(provider) {
        if (window.dataLayer) {
            window.dataLayer.push({
                'event': 'login_button_click',
                'provider': provider,
                'page_location': '/comments'
            });
        }
    }

    function trackLogoutClick() {
        if (window.dataLayer) {
            window.dataLayer.push({
                'event': 'logout_button_click',
                'page_location': '/comments'
            });
        }
    }

    // Отслеживание отправки формы комментария
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
        commentForm.addEventListener('submit', function (e) {
            const commentText = this.querySelector('textarea[name="body"]')?.value;
            if (window.dataLayer) {
                window.dataLayer.push({
                    'event': 'comment_submit',
                    'comment_length': commentText ? commentText.length : 0,
                    'page_location': '/comments'
                });
            }

            // Показываем индикатор загрузки
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = 'Отправка...';
                submitBtn.disabled = true;

                // Возвращаем текст через 3 секунды (на случай ошибки)
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 3000);
            }
        });
    }

    // Адаптивная высота textarea
    const textarea = document.getElementById('body');
    if (textarea) {
        textarea.addEventListener('input', function () {
            this.style.height = 'auto';
            const newHeight = Math.min(this.scrollHeight, 200); // Максимальная высота 200px
            this.style.height = newHeight + 'px';
        });
    }
</script>
{% endblock %}